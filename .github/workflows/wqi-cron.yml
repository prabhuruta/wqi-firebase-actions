name: WQI Window Service (manual)

on:
  workflow_dispatch: {}

jobs:
  run-wqi:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Decode Firebase service account JSON (from secret)
        env:
          FIREBASE_SA_JSON_B64: ${{ secrets.FIREBASE_SA_JSON_B64 }}
        run: |
          set -euo pipefail
          if [ -z "${FIREBASE_SA_JSON_B64:-}" ]; then
            echo "ERROR: FIREBASE_SA_JSON_B64 secret is missing"; exit 1
          fi
          echo "$FIREBASE_SA_JSON_B64" | base64 --decode > serviceAccountKey.json
          echo "Wrote serviceAccountKey.json (size: $(wc -c < serviceAccountKey.json) bytes)"
          python -c "import json,sys; json.load(open('serviceAccountKey.json')); print('serviceAccountKey.json OK')"

      - name: Run WQI window script (single pass)
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
          FIREBASE_DB_URL: ${{ secrets.FIREBASE_DB_URL }}
          FB_PATH_SENSOR: sensor_readings
          FB_PATH_WATERLOGS: waterLogs
          FB_PATH_RES_WINDOWS: wqi_window_results
          TIME_FIELD: timestamp
          TZ_LOCAL: Asia/Kolkata
          WINDOW_SIZE: "10"
          STEP_SIZE: "3"
          RUN_CONTINUOUS: "false"
          LOOKBACK_MIN: "10"
          USE_MODEL: "false"
          ARTIFACT_DIR: ./artifacts
        run: |
          echo "Starting WQI window job"
          ls -la
          python firebase_window_wqi_service.py
