name: WQI Window Service (cron)

on:
  schedule:
    - cron: "*/1 * * * *"   # every minute (UTC); change as needed
  workflow_dispatch:        # manual run button

jobs:
  run-wqi:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Create & validate service account JSON from secret
        env:
          FIREBASE_SA_JSON_B64: ${{ secrets.FIREBASE_SA_JSON_B64 }}
          FIREBASE_SA_JSON_RAW: ${{ secrets.FIREBASE_SA_JSON_RAW }}
        run: |
          set -euo pipefail

          # Prefer base64 secret if present
          if [ -n "${FIREBASE_SA_JSON_B64:-}" ]; then
            echo "[INFO] Using FIREBASE_SA_JSON_B64 (base64)"
            echo "$FIREBASE_SA_JSON_B64" | base64 --decode > serviceAccountKey.json
          elif [ -n "${FIREBASE_SA_JSON_RAW:-}" ]; then
            echo "[INFO] Using FIREBASE_SA_JSON_RAW (raw JSON)"
            echo "$FIREBASE_SA_JSON_RAW" > serviceAccountKey.json
          else
            echo "ERROR: Set either FIREBASE_SA_JSON_B64 or FIREBASE_SA_JSON_RAW secret."
            exit 1
          fi

          # Basic file checks
          echo "serviceAccountKey.json -> size: $(wc -c < serviceAccountKey.json) bytes"
          echo "----- head (first 200 chars) -----"
          head -c 200 serviceAccountKey.json | sed -n l || true
          echo "----- tail (last 200 chars) -----"
          tail -c 200 serviceAccountKey.json | sed -n l || true

          # Validate JSON by trying to load it in Python
          python - <<'PY'
import json,sys
try:
    json.load(open("serviceAccountKey.json"))
    print("✅ serviceAccountKey.json is valid JSON")
except Exception as e:
    print("❌ Invalid JSON in serviceAccountKey.json:", e)
    sys.exit(2)
PY

      - name: Create artifacts directory (for ML artifacts)
        run: |
          mkdir -p artifacts
          ls -la artifacts || true

      - name: Run window-level WQI (one-shot)
        env:
          # Firebase & service account
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
          FIREBASE_DB_URL: ${{ secrets.FIREBASE_DB_URL }}

          # database paths (adjust if needed)
          FB_PATH_SENSOR: sensor_readings
          FB_PATH_WATERLOGS: waterLogs
          FB_PATH_RES_WINDOWS: wqi_window_results

          # timestamp/time parsing options
          TIME_FIELD: timestamp
          TZ_LOCAL: Asia/Kolkata

          # windowing
          WINDOW_SIZE: "10"
          STEP_SIZE: "3"

          # run once per cron tick (no infinite loop)
          RUN_CONTINUOUS: "false"
          # how far back to fetch each run (minutes)
          LOOKBACK_MIN: "10"

          # ML options (set to "true" only after placing artifacts in ./artifacts)
          USE_MODEL: "false"
          ARTIFACT_DIR: ./artifacts
          ACCEPTABLE_MODEL_CLASSES: '["low"]'
        run: |
          echo "Running WQI window service (single pass)"
          python firebase_window_wqi_service.py
